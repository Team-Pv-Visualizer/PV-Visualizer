<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>PV-Visualizer</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="stylesheet" href="../css/fronius_dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
  </head>
  <style>
    #data-box {
      background-color: #f2f2f2;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      width: 100%;
      height: 100%;
      animation: fadeIn 1s;
    }

    #data-value {
      font-size: 50px;
      margin-bottom: 10px;
    }

    #data-date {
      font-size: 18px;
      opacity: 0.5;
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: translateY(-50%);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
  <body>
    <div class="header-hd">
      <h1>
        <span class="solar-panel-icon">
          <img src="https://www.solarweb.com/Content/images/fronius-logo.svg" alt="Solar Panel Icon" /> Fronius Dashboard </span>
      </h1>
      <a href="../index.html" class="home-button"></a>
    </div>
    <div style="display:flex; flex-wrap:wrap; justify-content: space-between;">
      <div style="flex:1 1 40%; margin:10px;height:300px;">
        <h2 style="text-align: center;">Heutige Leistung</h2>
        <canvas id="canvas2"></canvas>
      </div>
      <div style="flex:1 1 40%; margin:10px;height:300px;">
        <h2 style="text-align: center;">TÃ¤glicher Verbrauch</h2>
        <canvas id="canvas1"></canvas>
      </div>
      <div style="flex:1 1 40%; padding-top:55px;padding-right:25px;margin: 10px;">
        <div id="data-box">
          <h2>Aktuelle Leistung</h2>
          <div id="data-value"></div>
          <div id="data-date"></div>
        </div>
      </div>
      <div style="flex:1 1 40%; padding-top:25px; margin:10px;height:250px;">
        <h2 style="text-align: center;margin-bottom:0px;">Monatlicher Verbrauch</h2>
        <canvas id="canvas4"></canvas>
      </div>
    </div>
    <script>
      const dataBox = document.getElementById('data-box');
      const dataValue = document.getElementById('data-value');
      const dataDate = document.getElementById('data-date');

      function updateData() {
        fetch('../php/graph3.php').then(response => response.json()).then(data => {
          const value = data[0].Verbrauch;
          const date = new Date(data[0].Datum);
          dataValue.innerText = value;
          dataDate.innerText = date.toLocaleString();
        }).catch(error => {
          console.error('Error:', error);
        });
      }
      updateData();
      setInterval(updateData, 30000);
      dataBox.style.opacity = 0;
      dataBox.style.transition = 'opacity 0.5s';
      setTimeout(() => {
        dataBox.style.opacity = 1;
      }, 100);

      function updateChart() {
        const ctx = document.getElementById('canvas1');
        fetch('../php/graph1.php').then(response => response.json()).then(data => {
          const chartData = {
            labels: data.map(datum => datum.Datum),
            datasets: [{
              label: 'Stromverbrauch',
              data: data.map(datum => datum.Stromverbrauch),
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }]
          };
          new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                yAxes: [{
                  ticks: {
                    beginAtZero: true
                  }
                }]
              }
            }
          });
        });
        const chartElement = document.getElementById('canvas2');
        const ctx2 = chartElement.getContext('2d');
        let data = null;
        fetch('../php/graph2.php').then(response => response.json()).then(jsonData => {
          data = jsonData;
          const config = {
            type: 'line',
            data: {
              labels: data.map(item => item.time),
              datasets: [{
                label: 'Letzte 24 Stunden',
                data: data.map(item => item.value),
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  type: 'time',
                  time: {
                    format: 'YYYY-MM-DD HH:mm:ss',
                    tooltipFormat: 'll HH:mm'
                  }
                }
              }
            }
          };
          new Chart(ctx2, config);
        }).catch(error => {
          console.error('Error:', error);
        });
        const ctx4 = document.getElementById('canvas4');
        fetch('../php/graph4.php').then(response => response.json()).then(data => {
          const chartData = {
            labels: data.map(datum => datum.month),
            datasets: [{
              label: 'Stromverbrauch',
              data: data.map(datum => datum.Verbrauch),
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }]
          };
          new Chart(ctx4, {
            type: 'bar',
            data: chartData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                yAxes: [{
                  ticks: {
                    beginAtZero: true
                  }
                }]
              }
            }
          });
        });
      }
      updateChart();
      setInterval(updateChart, 30000);
    </script>
  </body>
</html>